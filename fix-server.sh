#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º —Å —Å–µ—Ä–≤–µ—Ä–æ–º

set -e

echo "üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º —Å —Å–µ—Ä–≤–µ—Ä–æ–º..."
echo ""

cd /home/soulpull/soulpull-app

# 1. –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º venv
echo "1. –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ..."
source venv/bin/activate

# 2. –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥
echo "2. –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥ –∏–∑ git..."
git pull origin main || echo "  ‚ö†Ô∏è  Git pull –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω (–≤–æ–∑–º–æ–∂–Ω–æ, –Ω–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π)"

# 3. –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏
echo "3. –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏..."
python manage.py migrate --noinput

# 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
echo "4. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é..."
if [ ! -f .env ]; then
    echo "  ‚ö†Ô∏è  –§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω! –°–æ–∑–¥–∞–π—Ç–µ –µ–≥–æ –∏–∑ .env.example"
fi

# 5. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã
echo "5. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã..."
sudo systemctl restart soulpull-backend
sleep 2
sudo systemctl status soulpull-backend --no-pager | head -10

echo ""
echo "6. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º nginx..."
sudo systemctl reload nginx
sudo systemctl status nginx --no-pager | head -5

echo ""
echo "‚úÖ –°–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω!"
echo ""
echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å:"
echo "  sudo systemctl status soulpull-backend"
echo "  sudo systemctl status nginx"
echo ""
echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:"
echo "  sudo journalctl -u soulpull-backend -n 50"
echo "  sudo tail -f /var/log/nginx/error.log"


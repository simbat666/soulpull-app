<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soulpull - TON Connect</title>
    <script src="https://unpkg.com/@tonconnect/ui@2.0.0/dist/tonconnect-ui.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 16px;
        }
        
        .status {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
            display: block;
        }
        
        .wallet-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
        }
        
        .wallet-info.active {
            display: block;
        }
        
        .wallet-address {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            word-break: break-all;
            color: #333;
            margin-top: 10px;
        }
        
        #connect-button {
            width: 100%;
            padding: 15px;
            background: #0088cc;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        #connect-button:hover {
            background: #006ba3;
        }
        
        #connect-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .api-url {
            font-size: 12px;
            color: #999;
            margin-top: 20px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Soulpull</h1>
        <p class="subtitle">–ü–æ–¥–∫–ª—é—á–∏—Ç–µ TON –∫–æ—à–µ–ª–µ–∫ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</p>
        
        <div id="status" class="status"></div>
        
        <button id="connect-button" onclick="connectWallet()">
            –ü–æ–¥–∫–ª—é—á–∏—Ç—å –∫–æ—à–µ–ª–µ–∫
        </button>
        
        <div id="wallet-info" class="wallet-info">
            <strong>–ö–æ—à–µ–ª–µ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω:</strong>
            <div class="wallet-address" id="wallet-address"></div>
        </div>
        
        <div class="api-url">API: <span id="api-url"></span></div>
    </div>

    <script>
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º API URL
        const API_BASE = window.location.origin + '/api/v1';
        document.getElementById('api-url').textContent = API_BASE;
        
        let walletAddress = null;
        let tonConnectUI = null;
        
        // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ DOM –∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ TON Connect
        function initTONConnect() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞
            if (typeof TON_CONNECT_UI === 'undefined') {
                console.error('TON Connect UI library not loaded');
                showStatus('–û—à–∏–±–∫–∞: –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ TON Connect –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞', 'error');
                return;
            }
            
            try {
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è TON Connect UI
                tonConnectUI = new TON_CONNECT_UI.TONConnectUI({
                    manifestUrl: window.location.origin + '/tonconnect-manifest.json',
                    language: 'ru'
                });
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
                tonConnectUI.connectionRestored.then(() => {
                    const account = tonConnectUI.account;
                    if (account) {
                        walletAddress = account.address;
                        handleWalletConnected(walletAddress);
                    }
                }).catch(err => {
                    console.log('No existing connection:', err);
                });
                
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫–æ—à–µ–ª—å–∫–∞
                tonConnectUI.onStatusChange((wallet) => {
                    if (wallet) {
                        walletAddress = wallet.account.address;
                        handleWalletConnected(walletAddress);
                    } else {
                        walletAddress = null;
                        document.getElementById('wallet-info').classList.remove('active');
                        showStatus('–ö–æ—à–µ–ª–µ–∫ –æ—Ç–∫–ª—é—á–µ–Ω', 'info');
                    }
                });
            } catch (error) {
                console.error('TON Connect initialization error:', error);
                showStatus('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ TON Connect: ' + error.message, 'error');
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                // –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ –∑–∞–≥—Ä—É–∑–∫—É —Å–∫—Ä–∏–ø—Ç–∞ TON Connect
                setTimeout(initTONConnect, 100);
            });
        } else {
            // DOM —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω
            setTimeout(initTONConnect, 100);
        }
        
        async function connectWallet() {
            if (!tonConnectUI) {
                showStatus('TON Connect –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.', 'error');
                return;
            }
            
            try {
                showStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–∞...', 'info');
                await tonConnectUI.openModal();
            } catch (error) {
                showStatus('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ' + error.message, 'error');
                console.error('Connect error:', error);
            }
        }
        
        async function handleWalletConnected(address) {
            showStatus('–ö–æ—à–µ–ª–µ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω! –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è...', 'info');
            
            try {
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
                const response = await fetch(API_BASE + '/register-wallet', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        wallet_address: address
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    showStatus(
                        data.created 
                            ? '‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!' 
                            : '‚úÖ –í—ã —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã!',
                        'success'
                    );
                    document.getElementById('wallet-address').textContent = address;
                    document.getElementById('wallet-info').classList.add('active');
                } else {
                    showStatus('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
                }
            } catch (error) {
                showStatus('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞: ' + error.message, 'error');
                console.error('Registration error:', error);
            }
        }
        
        function showStatus(message, type) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = 'status ' + type;
            statusEl.style.display = 'block';
            
            if (type === 'success' || type === 'error') {
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 5000);
            }
        }
    </script>
</body>
</html>
